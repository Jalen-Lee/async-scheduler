var AsyncScheduler=function(){"use strict";var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};var t=function(){return t=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},t.apply(this,arguments)};function n(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}function r(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{a(r.next(e))}catch(e){s(e)}}function u(e){try{a(r.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,u)}a((r=r.apply(e,t||[])).next())}))}function o(e,t){var n,r,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function u(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,u[0]&&(i=0)),i;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,r=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){i.label=u[1];break}if(6===u[0]&&i.label<o[1]){i.label=o[1],o=u;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(u);break}o[2]&&i.ops.pop(),i.trys.pop();continue}u=t.call(e,i)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}}function s(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}"function"==typeof SuppressedError&&SuppressedError;var i={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function o(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function s(e,t,r,s,i){if("function"!=typeof r)throw new TypeError("The listener must be a function");var u=new o(r,s||e,i),a=n?n+t:t;return e._events[a]?e._events[a].fn?e._events[a]=[e._events[a],u]:e._events[a].push(u):(e._events[a]=u,e._eventsCount++),e}function i(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function u(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),u.prototype.eventNames=function(){var e,r,o=[];if(0===this._eventsCount)return o;for(r in e=this._events)t.call(e,r)&&o.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(e)):o},u.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var o=0,s=r.length,i=new Array(s);o<s;o++)i[o]=r[o].fn;return i},u.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},u.prototype.emit=function(e,t,r,o,s,i){var u=n?n+e:e;if(!this._events[u])return!1;var a,c,l=this._events[u],f=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),f){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,o),!0;case 5:return l.fn.call(l.context,t,r,o,s),!0;case 6:return l.fn.call(l.context,t,r,o,s,i),!0}for(c=1,a=new Array(f-1);c<f;c++)a[c-1]=arguments[c];l.fn.apply(l.context,a)}else{var p,h=l.length;for(c=0;c<h;c++)switch(l[c].once&&this.removeListener(e,l[c].fn,void 0,!0),f){case 1:l[c].fn.call(l[c].context);break;case 2:l[c].fn.call(l[c].context,t);break;case 3:l[c].fn.call(l[c].context,t,r);break;case 4:l[c].fn.call(l[c].context,t,r,o);break;default:if(!a)for(p=1,a=new Array(f-1);p<f;p++)a[p-1]=arguments[p];l[c].fn.apply(l[c].context,a)}}return!0},u.prototype.on=function(e,t,n){return s(this,e,t,n,!1)},u.prototype.once=function(e,t,n){return s(this,e,t,n,!0)},u.prototype.removeListener=function(e,t,r,o){var s=n?n+e:e;if(!this._events[s])return this;if(!t)return i(this,s),this;var u=this._events[s];if(u.fn)u.fn!==t||o&&!u.once||r&&u.context!==r||i(this,s);else{for(var a=0,c=[],l=u.length;a<l;a++)(u[a].fn!==t||o&&!u[a].once||r&&u[a].context!==r)&&c.push(u[a]);c.length?this._events[s]=1===c.length?c[0]:c:i(this,s)}return this},u.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&i(this,t)):(this._events=new r,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=n,u.EventEmitter=u,e.exports=u}(i);var u,a=s(i.exports);function c(e,t){if("function"!=typeof e)throw new TypeError("[retryPromise]: Argument 1 must be a function that returns a promise!");return new Promise((function(n,r){var o=t||{},s=o.enable,i=void 0===s||s,u=o.retryInterval,a=o.retryCount,c=0,l=function(){Promise.resolve(e()).then(n).catch((function(e){if(i)if("number"==typeof a&&"number"==typeof u)++c<a?setTimeout((function(){return l()}),u):r(e);else if(++c<(a||3)){var t=Math.min(1e3*Math.pow(2,++c),3e4);setTimeout((function(){return l()}),t)}else r(e);else r(e)}))};l()}))}!function(e){e[e.SERIAL=0]="SERIAL",e[e.PARALLEL=1]="PARALLEL"}(u||(u={}));var l=Object.freeze({ALL_SETTLED:Symbol("AsyncScheduler#all_settled"),PARTIAL_SETTLED:Symbol("AsyncScheduler#partial_settled"),TASK_RESOLVED:Symbol("AsyncScheduler#task_resolved"),TASK_REJECTED:Symbol("AsyncScheduler#task_rejected")});return function(s){function i(e){var t=s.call(this)||this;return t.options={concurrency:6,retry:{enable:!0}},t.executeQueue=[],t.waitingQueue=[],t.options=Object.assign(t.options,e),t}return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}(i,s),i.prototype.serial=function(e,t,n,r){if(void 0===r&&(r={}),!Array.isArray(t))throw TypeError("Failed to execute 'parallel' on 'AsyncTaskScheduler': Parameter 2 <tasks> must be an array!");return r=Object.assign({},this.options,r),this.waitingQueue.push({type:u.SERIAL,id:e,tasks:t,initialValue:n,options:r}),this},i.prototype.parallel=function(e,t,n,r){if(void 0===r&&(r={}),!Array.isArray(t))throw TypeError("Failed to execute 'parallel' on 'AsyncTaskScheduler': Parameter 2 <tasks> must be an array!");return r=Object.assign({},this.options,r),this.waitingQueue.push({type:u.PARALLEL,id:e,tasks:t,initialValue:n,options:r}),this},i.prototype.execute=function(){var e=this;return 0===this.waitingQueue.length&&console.warn('[AsyncTaskScheduler]ï¼šThe queue of tasks to be executed is empty.Use the "serial","parallel" method to add tasks.'),this.waitingQueue.forEach((function(t){t.type===u.SERIAL?e.executeQueue.push({id:t.id,taskFn:function(){return e.executeInSeries(t.tasks,t.initialValue,t.options)}}):t.type===u.PARALLEL&&e.executeQueue.push({id:t.id,taskFn:function(){return e.executeInParallel(t.tasks,t.initialValue,t.options)}})})),this.executeQueue.length>0&&this.executeInSeries(this.executeQueue).then((function(t){var n=t.results;e.emit(l.ALL_SETTLED,n)})),this},i.prototype.executeInSeries=function(e,s,u){return void 0===u&&(u=this.options),r(this,void 0,void 0,(function(){var r,a,c,f,p,h,y;return o(this,(function(v){switch(v.label){case 0:r=[],a=s,c=function(e){var s,c,p,h,y;return o(this,(function(o){switch(o.label){case 0:if(s=e.taskFn,c=n(e,["taskFn"]),"function"!=typeof s)throw new TypeError("[AsyncScheduler]: <taskFn> must be a function that returns a promise!");o.label=1;case 1:return o.trys.push([1,3,,4]),[4,i.retryPromise((function(){return s(a)}),u.retry)];case 2:return p=o.sent(),y=t(t({},c),{result:p}),f.emit(l.TASK_RESOLVED,y),r.push(y),a=p,[3,4];case 3:return h=o.sent(),y=t(t({},c),{result:h}),f.emit(l.TASK_REJECTED,y),r.push(y),[3,4];case 4:return[2]}}))},f=this,p=0,h=e,v.label=1;case 1:return p<h.length?(y=h[p],[5,c(y)]):[3,4];case 2:v.sent(),v.label=3;case 3:return p++,[3,1];case 4:return[2,{lastValue:a,results:r}]}}))}))},i.prototype.executeInParallel=function(e,r,o){var s=this;return void 0===o&&(o=this.options),new Promise((function(u,a){var c=0,f=[],p=[],h=function(){if(c===e.length)return Promise.resolve();var u=e[c++],a=u.taskFn,y=n(u,["taskFn"]);if("function"!=typeof a)throw new TypeError("[AsyncScheduler]: <taskFn> must be a function that returns a promise!");var v=i.retryPromise((function(){return a(r)}),o.retry).then((function(e){var n=t({result:e},y);return s.emit(l.TASK_RESOLVED,n),n})).catch((function(e){s.emit(l.TASK_REJECTED,t({result:e},y))}));f.push(v);var b=Promise.resolve();if(o.concurrency<=e.length){var d=v.then((function(){return p.splice(p.indexOf(d),1)}));p.push(d),p.length>=o.concurrency&&(b=Promise.race(p))}return b.then((function(){return h()}))};h().then((function(){return Promise.all(f)})).then(u)}))},i.TaskState=l,i.retryPromise=c,i}(a)}();
